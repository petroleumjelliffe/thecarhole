<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  .minuteHand{
    stroke:#000;
    stroke-width:2px;
  }
    .hourHand{
    stroke:#000;
    stroke-width:4px;
    stroke-linecap:round;
  }
  .background{fill:#0cf}
.temp {
  fill:none;
  stroke:#666;
  stroke-dasharray: 1,4;
  }
  .minute {
    fill:#fff;
    stroke:none;
  }
  .hour {
    fill:none;
    stroke: #000;
  }



.frame {
  fill: none;
  stroke: #000;
}
  .rticks, .hticks {
    stroke: #ccc;
    stroke-width: 1;
  }
.gbar text {
  fill: none;
}
.gbar:hover text {
  fill:#ccc;
}
.temp {
  font: 1em sans-serif;

}
.axis text {
  font: 1.5em sans-serif;
  text-anchor: right;
}


.axis circle {
  fill: none;
  stroke: #777;
  stroke-dasharray: 1,4;
}

.axis :last-of-type circle {
  stroke: #333;
  stroke-dasharray: none;
}

.line {
  fill: none;
  stroke: red;
  stroke-width: 1.5px;
}

.bar {
  /* fill:#333; */
}

.major-axis {
  stroke:#000;
  stroke-width:1.5
}
.labelHours {
  font-family: sans-serif;
  font-size: 2em;
}


/* svg {
  fill: #ccc;
} */

</style>
</head>
<body>
  <svg width="450" height="450"></svg>
    <p id="output">

    </p>

  <form method="get" id="coords" >
    <input type="button" value="locate" onclick="geoFindMe()">
    <input type="text" name="lat" id="lat">
    <input type="text" name="lon" id="lon">
    <input type="button" value="GO" onclick="update()">

  </form>
  <!-- <button onclick="update()">GO</button> -->
<script src="//d3js.org/d3.v4.min.js"></script>
<script>

    //get the svg element
    var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;


    var r0Precip=120,
        rMaxPrecip = 170,
        rLowTemp = 75,
        rHighTemp = 100,
        rMajorTick = r0Precip-20,
        rMinorTick = r0Precip-10,
        rWatchFace = 210,
        rMinuteDial = rWatchFace * 3,
        rInner = 120,
        rHourLabels = rInner-15,

        rHourDial = rInner,

        rOffsetHours = 2*rInner



    var thetaMinute = d3.scaleLinear()
      .domain([0,60])
      .range([0,2*Math.PI])

    var thetaDay = d3.scaleLinear()
      .domain([0,24])
      .range([0,8*Math.PI/2])

    var rTempRange = d3.scaleLinear()
      .range([rLowTemp, rHighTemp])

    var rPrecipIntensity = d3.scaleLinear()
      .range([rMaxPrecip ,r0Precip])
      .domain([.1,0])

    //precipitation
    var minutelyTrend = d3.radialLine()
      .angle(function(d) {
        var time = new Date(d.time*1000)
        console.log(time)
        console.log(time.getMinutes())
        return thetaMinute(time.getMinutes())
      })
      // .radius(function(d) {return r(Math.cos((theta1year(offsetDate(d, now))+Math.PI)/4))})
      .radius(function(d) {return rPrecipIntensity(d.precipIntensity)})
      .curve(d3.curveCatmullRom)

    //temperature by the hour
    var hourlyTrend = d3.radialLine()
      .angle(function(d) {
        var time = new Date(d.time*1000)
        console.log(time.getHours())

        return thetaDay(time.getHours())
      })
      // .radius(function(d) {return r(Math.cos((theta1year(offsetDate(d, now))+Math.PI)/4))})
      .radius(function(d) {return rTempRange(d.temperature)})
      // .curve(d3.curveCatmullRom)

      function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;

        return {
          x: centerX + (radius * Math.cos(angleInRadians)),
          y: centerY + (radius * Math.sin(angleInRadians))
        };
      }

      function describeArc(x, y, radius, startAngle, endAngle){

          var start = polarToCartesian(x, y, radius, endAngle);
          var end = polarToCartesian(x, y, radius, startAngle);

          var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

          var d = [
              "M", start.x, start.y,
              "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
          ].join(" ");

          return d;
      }
      console.log(describeArc(width/2,height/2,30,0,30));
      console.log(describeArc(width/2,height/2,50,30,0));





    //CREATE THE DOM
    //g is a  group centered on the page
    //watchface is a circle masks the hour and minute dials
    //hourDial is a group that contains taxt digits  1-12
    //minuteDial is a group that contains major and minor ticks
    var g = svg.append("g")
        .attr("transform", "translate(" + width/2 + "," + height/2 + ")");



    g.append("circle")
      .attr("class","background")
      .attr("r",149)
      g.append("circle")
        // .attr("class","background")
        .attr("r",rInner)
        .attr("fill","blue")


    //set the axes
    var gr = g.append("g")
        .attr("class", "axis axis--r")
        // .attr("transform", "translate(0," + height + ")")

    var mTicks = d3.scaleLinear().domain([0,60])
    var hTicks = d3.scaleLinear().domain([1,12])

    //create a HourDial to contain the numerals, and be rotated accordingly
    var hourDial = g.append("g")
        .attr("class", "hourDial")
    var minuteDial = g.append("g")
        .attr("class", "minuteDial")

    hourDial.append("circle")
      .attr("r",rHourDial)
      .attr("fill","white")

    //add the 12 numerals, and place them accordingly
    var hourNumerals = hourDial.selectAll(".labelHours")
      .data(hTicks.ticks(12))
      .enter().append("text")
      .attr("class","labelHours")
      .attr("x",function(d) { return rHourLabels*Math.cos(Math.PI/2+(d/12*2*Math.PI))})
      .attr("y",function(d) { return rHourLabels*Math.sin(Math.PI/2+(d/12*2*Math.PI) )})
      .attr("text-anchor","middle")
      .attr("alignment-baseline","central")
      .attr("transform", function(d){return `rotate(${-(d/6)*360})`})
      .text(function(d){return d})


    var minorTicks = minuteDial.selectAll(".rticks")
      .data(mTicks.ticks(60))
      .enter().append("line")
      .attr("class","rticks")
      .attr("x1",function(d) { return rMinorTick*Math.cos(d*2*Math.PI/60 )})
      .attr("x2",function(d) { return r0Precip*Math.cos(d*2*Math.PI/60 )})
      .attr("y1",function(d) { return rMinorTick*Math.sin(d*2*Math.PI/60 )})
      .attr("y2",function(d) { return r0Precip*Math.sin(d*2*Math.PI/60 )})

    var majorTicks = minuteDial.selectAll(".hticks")
      .data(mTicks.ticks(12))
      .enter().append("line")
      .attr("class","hticks")
      .attr("x1",function(d) { return rMajorTick*Math.cos(d*2*Math.PI/60 )})
      .attr("x2",function(d) { return r0Precip*Math.cos(d*2*Math.PI/60 )})
      .attr("y1",function(d) { return rMajorTick*Math.sin(d*2*Math.PI/60 )})
      .attr("y2",function(d) { return r0Precip*Math.sin(d*2*Math.PI/60 )})



    var gHands = g.append("g")
        .attr("class", "hands")

    gHands.append("line")
      .attr("class","minuteHand")
            .attr("x1",0)
          .attr("y1",0)


    gHands.append("line")
      .attr("class","hourHand")
            .attr("x1",0)
          .attr("y1",0)








  var update = function(data) {
    var deltaT = (data.getHours()%12+data.getMinutes()/60)/12
    // console.log(deltaT);
    //data is a timestamp
    var selectHourDial = g.selectAll(".hourDial")
      .data([deltaT])

    //new items
    var enterHourDial =  selectHourDial.enter()
      .append("g")
      .attr("class", "hourDial")

    //update the existing and new elements
    var updateHourDial = selectHourDial.merge(enterHourDial)

    //update properties for new and existing items
    updateHourDial
      .attr("transform", function(d) {
        var theta=Math.PI/2-(d*2*Math.PI)
        var offset= [rOffsetHours*Math.cos(theta), rOffsetHours*Math.sin(theta)]

        //move the dial where the hour hand would go, and rotate the face to line up the numeral
        return `translate(${offset[0]}, ${-offset[1]}) rotate(${2*d*360})`
      })

    //remove old ones
    var exitHourDial = selectHourDial.exit()
    exitHourDial.remove()

  }





  // update()

  var step = function(timestamp) {
    // console.log("hi")
    var now = new Date(2018,11,25,23,00)

    //every minute, rotate the hourDial about the watchFace center, and its own center
    update(now)

        var minuteHand = gHands.selectAll(".minuteHand")
          .data([new Date()])
          .attr("x2",function(d) { return r0Precip * Math.cos((d.getMinutes()+d.getSeconds()/60)*2*Math.PI/60 -Math.PI/2)})
          .attr("y2",function(d) { return r0Precip * Math.sin((d.getMinutes()+d.getSeconds()/60)*2*Math.PI/60 -Math.PI/2)})

        var hourHand = gHands.selectAll(".hourHand")
          .data([new Date()])
          .attr("x2",function(d) { return rHighTemp * Math.cos((d.getHours()-d.getTimezoneOffset()+d.getMinutes()/60)*2*Math.PI/12 -Math.PI/2)})
          .attr("y2",function(d) { return rHighTemp * Math.sin((d.getHours()-d.getTimezoneOffset()+d.getMinutes()/60)*2*Math.PI/12 -Math.PI/2)})

    window.requestAnimationFrame(step);

        // window.cancelAnimationFrame(snapback)
  }
  var snapback =   window.requestAnimationFrame(step);

</script>

<!-- <a href="whatsapp://send?text=https%3A%2F%2Fwww.paperlesspost.com%2Fflyer%2Fgo%2FNaad3Q7FBZqyQNtXjb0V%3Futm_campaign%3Dflyer-share-dialog%26utm_source%3Dwhatsapp" data-action="share/whatsapp/share">Share via Whatsapp</a>
<a href="https://api.whatsapp.com/send?text=https%3A%2F%2Fwww.paperlesspost.com%2Fflyer%2Fgo%2FNaad3Q7FBZqyQNtXjb0V%3Futm_campaign%3Dflyer-share-dialog%26utm_source%3Dwhatsapp" data-action="share/whatsapp/share">Share via Whatsapp</a> -->

</body>
</html>
