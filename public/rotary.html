"<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

.hello, .hole {
  color:black;
  stroke: black;
  font-size: 16px
}
.frame {
  fill: none;
  stroke: #000;
}
text, .digit {
  color:black;
  fill:black;

  text-anchor:middle;
  alignment-baseline:middle;

}
.gbar text {
  fill: none;
}
.gbar:hover text {
  fill:#ccc;
}
.temp {
  font: 1em sans-serif;

}
.axis text {
  font: 1.5em sans-serif;
  text-anchor: right;
}


.axis line,
.axis circle {
  fill: none;
  stroke: #777;
  stroke-dasharray: 1,4;
}

.axis :last-of-type circle {
  stroke: #333;
  stroke-dasharray: none;
}

.line {
  fill: none;
  stroke: red;
  stroke-width: 1.5px;
}

.bar {
  /* fill:#333; */
}

.major-axis {
  stroke:#000;
  stroke-width:1.5
}

svg {
  fill: #ccc;
}

</style>
</head>
<body id="body">
  <svg width="600" height="400"></svg>


<script src="//d3js.org/d3.v4.min.js"></script>
<script>

  //get the svg element
  var svg = d3.select("svg"),
      margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = +svg.attr("width") - margin.left - margin.right,
      height = +svg.attr("height") - margin.top - margin.bottom;

  //set the scales
  // var x = d3.scaleTime().range([0, width-margin.left -margin.right])
  var x = d3.scaleBand()
    .range([0, width-margin.left-margin.right])
    .padding(0.2)

  var y = d3.scaleLinear()
    .range([height-margin.top, 0])

  var colors = d3.scaleLinear()
    .domain([0,70,100]) //temps
    .interpolate(d3.interpolateCubehelix)
    .range([d3.hsl(220,1, .5), d3.hsl(220,1,1), d3.hsl(0,1,.5)]);

  //create the parent element
  var g = svg.append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ") ")
  // .attr("transform", "rotate(" + 45+ ")")

  var center =[150,150]
  var r=100
  var theta = Math.PI*2/12

  var rotary = g.selectAll(".hole")
    .data([1,2,3,4,5,6,7,8,9,0])
    .enter().append("circle")
    .attr("class","hole")
    .attr("cx", function(d,i) {return center[0]+r*Math.cos(i*theta)})
    .attr("cy", function(d,i) {return center[1]+r*-Math.sin(i*theta)})
    .attr("r", 20)
    .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));


  var digits = g.selectAll(".digit")
    .data([1,2,3,4,5,6,7,8,9,0])
    .enter().append("text")
    .text(function(d) { return d })
    .attr("class","digit")
    .attr("x", function(d,i) {return center[0]+r*Math.cos(i*theta)})
    .attr("y", function(d,i) {return center[1]+r*-Math.sin(i*theta)})


  var p0=[], p1=[], theta0, thetaMin

  var angle = function (x,y) {
    return ((Math.atan2(y,x)*180/Math.PI)+30+360)%360
  }
  function dragstarted(d) {
    d3.select(this).raise().classed("active", true);
    p0=[d3.event.x,d3.event.y]
    // theta0=Math.atan2(p0[1]-center[1], p0[0]-center[0])
    theta0=angle(p0[1]-center[1], p0[0]-center[0])
    // p0=[rotary.data()[0].x,rotary.data()[0].y]
    // console.log(`started at ${p0}`);
    // console.log(`started at ${rotary.data()[0].x}`);
    console.log(`started at ${d3.event.x}, ${d3.event.y}`);
    console.log(`theta0 ${theta0*180/Math.PI}}`);
  }

  function dragged(d) {
    // d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
    p1=[d3.event.x,d3.event.y]
    theta1=angle(p1[1]-center[1], p1[0]-center[0])
    // dtheta = theta0-theta1
    dtheta = angle(d3.event.x-d3.event.dx,d3.event.y-d3.event.dy)-theta1
    //ratchet the toary, only rotate it CW
    if (dtheta <0) {
      thetaMin = Math.min(thetaMin, theta1)
      rotary.attr("transform", `rotate(${thetaMin} ${center[0]} ${center[1]})`)

    }
    // 
    //
    // dx=p1[0]-p0[0]
    // dy=p1[1]-p0[1]

    console.log(`${dtheta}`);
    // rotary.attr("transform", `rotate(${-dtheta*180/Math.PI} ${center[0]} ${center[1]})`)
  }

  function dragended(d) {
    d3.select(this).classed("active", false);
    console.log("ended");

    // rotary.transition()
    //   .duration(1000)
    //   .attr("transform", `rotate(0 ${center[0]} ${center[1]})`)
    //   .attr()

      // var step = function(timestamp) {
      //   var t = timestamp/1000%1
      //   var thetaPerSecond = Math.PI/2
      //   // console.log(t);
      //   // update(t)
      //   var theta = thetaPerSecond * t
      //   toary.attr("transform", `rotate(${theta} ${center[0]} ${center[1]})`)
      //
      //   window.requestAnimationFrame(step);
      // }
      // var snapback =   window.requestAnimationFrame(step);
  }


</script>
</body>
</html>
